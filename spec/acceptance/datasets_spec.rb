require 'spec_helper'

resource "Greenplum Tables / Views" do
  let(:dataset) { FactoryGirl.create(:gpdb_table, :name => "my_table") }
  let(:owner) { dataset.schema.instance.owner }
  let!(:owner_account) { FactoryGirl.create(:instance_account, :instance => dataset.instance, :owner => owner) }
  let(:dataset_id) { dataset.id }
  let!(:event) { FactoryGirl.create(:source_table_created_event, :dataset => dataset) }
  let!(:activity) { Activity.create!(:entity => dataset, :event => event) }
  let!(:statistics) { FactoryGirl.build(:dataset_statistics) }

  let(:result) do
    SqlResults.new(
      [
        { :name => "column_1", :data_type => "integer", :type_category => "WHOlE_NUMBER", :description => "first col" },
        { :name => "column_1", :data_type => "double", :type_category => "REAL_NUMBER", :description => "second col" }
      ],
      [[1, 2.0], [5, 2.5]]
    )
  end

  before do
    log_in owner
    stub(SqlResults).preview_dataset { result }
    stub(GpdbColumn).columns_for.with_any_args { [FactoryGirl.build(:gpdb_column), FactoryGirl.build(:gpdb_column)] }
    any_instance_of(Dataset) do |u| 
      stub(u).add_metadata!.with_any_args { statistics }
      stub(u).statistics.with_any_args { statistics }
    end
  end

  post "/datasets/:dataset_id/previews" do
    parameter :dataset_id, "Table / View ID"
    parameter :check_id, "An identifier (generated by the client) which can be used to cancel this preview later"
    required_parameters :dataset_id, :check_id

    scope_parameters :task, [:check_id]

    let(:check_id) { '42' }

    example_request "Preview 100 rows" do
      status.should == 201
    end
  end

  get "/datasets/:dataset_id/activities" do
    example_request "Get all activities for specified dataset" do
      status.should == 200
    end
  end

  get "/datasets/:dataset_id/columns" do
    example_request "Get all columns for specified dataset" do
      status.should == 200
    end
  end

  get "/datasets/:dataset_id/statistics" do
    example_request "Get statistics for specified dataset" do
      status.should == 200
    end
  end
end
